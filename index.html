<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社群快報 - The Daily Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for Newspaper Feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration & Global State ---
        const firebaseConfig = JSON.parse(localStorage.getItem('firebase_config') || '{}'); 
        // Note: In the immersive environment, we use the injected config. 
        // Below is the logic to handle the environment variables provided by the system.

        let app, auth, db, appId;
        let currentUser = null;
        let username = "";

        // Function to initialize Firebase based on system environment
        async function initFirebase() {
            try {
                // Accessing global variables provided by the environment
                const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const config = JSON.parse(configStr);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';

                app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);

                // Auth Flow
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        console.log("User authenticated:", user.uid);
                        initChatListener(); // Start listening to messages
                    }
                });

            } catch (error) {
                console.error("Firebase init error:", error);
                document.getElementById('loading-text').textContent = "系統連線錯誤，請稍後再試。";
            }
        }

        // --- Chat Logic ---

        // Listen for messages in Firestore
        function initChatListener() {
            if (!currentUser) return;

            // Strict Path: artifacts/{appId}/public/data/messages
            const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'newspaper_chat');

            // Using simple query, sorting in memory as per instructions
            onSnapshot(messagesRef, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp (handling potential null timestamps for local writes)
                messages.sort((a, b) => {
                    const t1 = a.timestamp ? a.timestamp.seconds : Date.now() / 1000;
                    const t2 = b.timestamp ? b.timestamp.seconds : Date.now() / 1000;
                    return t1 - t2;
                });

                renderMessages(messages);
            }, (error) => {
                console.error("Error fetching messages:", error);
            });
        }

        // Send a message
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !currentUser || !username) return;

            try {
                const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'newspaper_chat');
                
                await addDoc(messagesRef, {
                    text: text,
                    sender: username,
                    uid: currentUser.uid,
                    timestamp: serverTimestamp(),
                    type: 'message' // could be 'ad' or 'news' later
                });

                input.value = '';
                // Auto scroll happens in render
            } catch (e) {
                console.error("Error sending message:", e);
                alert("發送失敗，請重試");
            }
        }
        
        // EXPOSE TO WINDOW (Critical Fix)
        window.sendMessage = sendMessage;

        // --- UI Logic ---

        // Render the list of messages
        function renderMessages(messages) {
            const container = document.getElementById('chat-feed');
            container.innerHTML = ''; // Clear current

            let lastSender = '';

            messages.forEach(msg => {
                const isMe = msg.uid === currentUser?.uid;
                
                // Create Message Element
                const msgDiv = document.createElement('div');
                msgDiv.className = `mb-6 relative break-inside-avoid ${isMe ? 'pl-8' : 'pr-8'}`;

                // Timestamp formatting
                let timeStr = "";
                if(msg.timestamp) {
                    const date = new Date(msg.timestamp.seconds * 1000);
                    timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }

                // Random rotation for visual interest (very subtle)
                const rot = Math.random() * 2 - 1; 

                msgDiv.innerHTML = `
                    <div class="border-b border-stone-400 pb-2" style="transform: rotate(${rot}deg)">
                        <div class="flex justify-between items-baseline mb-1 font-serif">
                            <span class="font-bold text-lg text-stone-900 ${isMe ? 'text-indigo-900' : ''}">
                                ${isMe ? '★ ' : ''}${escapeHtml(msg.sender)}
                            </span>
                            <span class="text-xs text-stone-500 font-sans tracking-widest">${timeStr}</span>
                        </div>
                        <p class="text-stone-800 text-base leading-relaxed font-serif text-justify">
                            ${escapeHtml(msg.text)}
                        </p>
                    </div>
                `;
                container.appendChild(msgDiv);
            });

            // Scroll to bottom
            const scrollContainer = document.getElementById('feed-container');
            scrollContainer.scrollTop = scrollContainer.scrollHeight;
        }

        // Helper to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // --- Event Listeners & Bootstrapping ---

        window.enterChat = () => {
            const nameInput = document.getElementById('username-input');
            const name = nameInput.value.trim();
            if (name) {
                username = name;
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-interface').classList.remove('hidden');
                document.getElementById('current-user-display').textContent = `特派員: ${username}`;
                
                // Initialize Firebase only after user intends to enter
                // But for better UX, we init auth first, then data listens later
                initFirebase();
            } else {
                nameInput.classList.add('border-red-500');
            }
        };

        window.handleKeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        // Initialize things on load
        window.onload = () => {
            // Set today's date in header
            const dateOpts = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('zh-TW', dateOpts);
        };
    </script>

    <style>
        /* Custom Styles for Paper Texture & Typography */
        body {
            background-color: #f4f1ea;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d6d3c9' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
            color: #2c2c2c;
        }
        .font-serif {
            font-family: 'Noto Serif TC', serif;
        }
        .font-headline {
            font-family: 'Playfair Display', serif;
        }
        
        /* Custom Scrollbar for the retro feel */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e4e0d5;
        }
        ::-webkit-scrollbar-thumb {
            background: #8c887e; 
            border: 1px solid #f4f1ea;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        /* Newspaper specific utilities */
        .newspaper-border-top {
            border-top: 4px double #1a1a1a;
        }
        .newspaper-border-bottom {
            border-bottom: 4px double #1a1a1a;
        }
        .paper-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 40px rgba(0,0,0,0.05) inset;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-stone-900">

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-[#f4f1ea] p-8 max-w-md w-full border-8 border-double border-stone-800 shadow-2xl relative">
            <div class="absolute -top-4 -left-4 w-8 h-8 bg-stone-800"></div>
            <div class="absolute -bottom-4 -right-4 w-8 h-8 bg-stone-800"></div>
            
            <h1 class="font-headline text-4xl font-black text-center mb-2 uppercase tracking-tighter">社群快報</h1>
            <p class="text-center font-serif italic text-stone-600 mb-8 border-b border-stone-400 pb-2">The Community Express</p>
            
            <div class="space-y-4">
                <label class="block font-serif font-bold text-lg">請輸入您的筆名：</label>
                <input type="text" id="username-input" class="w-full bg-[#ebe7dd] border-b-2 border-stone-800 p-3 font-serif text-xl focus:outline-none focus:bg-white transition-colors placeholder-stone-400" placeholder="例如：張三、神祕客...">
                <button onclick="enterChat()" class="w-full bg-stone-900 text-[#f4f1ea] font-headline font-bold text-xl py-3 mt-4 hover:bg-stone-700 transition-colors uppercase tracking-widest border border-transparent hover:border-black">
                    進入閱覽室
                </button>
            </div>
            <p id="loading-text" class="mt-4 text-xs text-center font-mono text-stone-500">正在等待伺服器連線...</p>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface" class="hidden flex-1 flex flex-col max-w-5xl w-full mx-auto h-full shadow-2xl border-x border-stone-300 bg-[#f4f1ea] relative">
        
        <!-- HEADER -->
        <header class="pt-6 pb-2 px-4 md:px-8 bg-[#f4f1ea] z-10 shrink-0">
            <div class="flex justify-between items-end border-b-4 border-black border-double mb-2 pb-1">
                <div class="text-xs md:text-sm font-bold uppercase tracking-widest font-sans flex flex-col">
                    <span>Vol. 1, No. 1</span>
                    <span id="date-display">loading...</span>
                </div>
                <div class="text-center">
                    <h1 class="font-headline text-4xl md:text-6xl font-black uppercase tracking-tighter leading-none">社群快報</h1>
                    <div class="text-[0.6rem] md:text-xs font-serif italic mt-1 uppercase tracking-[0.3em]">The Daily Community Chronicle</div>
                </div>
                <div class="text-right text-xs md:text-sm font-bold uppercase tracking-widest font-sans flex flex-col items-end">
                    <span>Weather: Cloudy</span>
                    <span>Price: Free</span>
                </div>
            </div>
            
            <!-- User Status Bar -->
            <div class="flex justify-between items-center py-2 border-b border-stone-800">
                <span id="current-user-display" class="font-bold font-serif text-stone-700"></span>
                <div class="flex space-x-4 text-xs font-sans uppercase tracking-widest text-stone-500">
                    <span>Live Updates</span>
                    <span>•</span>
                    <span>Public Channel</span>
                </div>
            </div>
        </header>

        <!-- CONTENT AREA (Split View) -->
        <main class="flex-1 overflow-hidden flex flex-col md:flex-row relative">
            
            <!-- Left Sidebar (Desktop Only Decor) -->
            <aside class="hidden md:block w-48 p-4 border-r border-stone-300 shrink-0 overflow-y-auto bg-[#f0ebd8]/30">
                <div class="mb-6">
                    <h3 class="font-sans font-bold uppercase text-xs tracking-widest border-b border-stone-800 mb-2">今日公告</h3>
                    <p class="font-serif text-sm text-justify leading-snug">歡迎來到社群快報。所有言論均即時發佈，請保持文明用語，共同維護閱覽室秩序。</p>
                </div>
                <div class="mb-6">
                    <h3 class="font-sans font-bold uppercase text-xs tracking-widest border-b border-stone-800 mb-2">廣告</h3>
                    <div class="border border-stone-800 p-2 text-center">
                        <p class="font-serif font-bold text-lg mb-1">誠徵筆友</p>
                        <p class="font-serif text-xs italic">意者請於聊天室留言。</p>
                    </div>
                </div>
                <div class="opacity-50 text-center mt-10">
                    <div class="w-12 h-12 border rounded-full mx-auto mb-2 flex items-center justify-center border-stone-400">
                        <span class="font-serif text-2xl italic">Ads</span>
                    </div>
                    <p class="text-[10px] font-sans">Space Available</p>
                </div>
            </aside>

            <!-- Center: The Chat Feed -->
            <section class="flex-1 flex flex-col relative bg-gradient-to-b from-[#f4f1ea] to-[#eeeadd]">
                
                <!-- Messages Container -->
                <div id="feed-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                    <div class="max-w-2xl mx-auto" id="chat-feed">
                        <!-- Messages will be injected here -->
                        <div class="text-center my-10 opacity-60">
                            <h3 class="font-headline text-2xl mb-2">等待新訊...</h3>
                            <div class="w-16 h-1 bg-stone-800 mx-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 bg-[#e8e4db] border-t-2 border-stone-800 relative z-20">
                    <div class="max-w-3xl mx-auto flex gap-2">
                        <div class="flex-1 relative">
                            <input type="text" id="message-input" onkeydown="handleKeydown(event)"
                                class="w-full h-full min-h-[50px] bg-[#fdfbf7] border border-stone-400 p-3 font-serif text-lg focus:outline-none focus:border-stone-900 focus:ring-1 focus:ring-stone-900 shadow-inner" 
                                placeholder="撰寫快訊... (Enter 發送)">
                        </div>
                        <button onclick="sendMessage()" class="bg-stone-800 text-[#f4f1ea] px-6 py-2 font-headline font-bold uppercase tracking-widest hover:bg-stone-700 transition active:translate-y-1 shadow-lg">
                            發佈<br><span class="text-xs font-sans font-normal">Publish</span>
                        </button>
                    </div>
                </div>
            </section>

        </main>
        
        <!-- Footer -->
        <footer class="bg-[#e0dcd1] py-1 px-4 text-center border-t border-stone-300">
            <p class="text-[10px] font-sans uppercase tracking-widest text-stone-500">Printed in Digital Hsinchu • Copyright &copy; 2025</p>
        </footer>

    </div>

</body>
</html>